# Sanitizer CI Jobs
# Memory safety and thread safety testing with AddressSanitizer, ThreadSanitizer,
# UndefinedBehaviorSanitizer, and MemorySanitizer
#
# Critical for detecting:
# - Buffer overflows in RandomX context handling
# - Use-after-free in cache/dataset management
# - Data races in context pool
# - Undefined behavior in cryptographic operations

name: Sanitizers

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: 500M

jobs:
  asan:
    name: AddressSanitizer (ASan)
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build ccache \
            libboost-all-dev libevent-dev libsqlite3-dev \
            libssl-dev clang-17 llvm-17

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-asan-${{ github.sha }}
          restore-keys: |
            ccache-asan-

      - name: Configure with ASan
        run: |
          cmake -B build-asan -G Ninja \
            -DCMAKE_C_COMPILER=clang-17 \
            -DCMAKE_CXX_COMPILER=clang++-17 \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_FLAGS="-fsanitize=address -fno-omit-frame-pointer -g" \
            -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer -g" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address" \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DBUILD_TESTS=ON

      - name: Build with ASan
        run: cmake --build build-asan -j$(nproc)

      - name: Run unit tests with ASan
        env:
          ASAN_OPTIONS: "detect_leaks=1:check_initialization_order=1:strict_init_order=1:detect_stack_use_after_return=1"
        run: |
          ./build-asan/bin/test_opensy --run_test=randomx_tests
          ./build-asan/bin/test_opensy --run_test=randomx_pool_tests
          ./build-asan/bin/test_opensy --run_test=pow_tests

      - name: Run RandomX-specific tests with ASan
        env:
          ASAN_OPTIONS: "detect_leaks=1:check_initialization_order=1"
        run: |
          # Run reorg tests which stress context management
          ./build-asan/bin/test_opensy --run_test=randomx_reorg_tests || true
          # Run high priority tests
          ./build-asan/bin/test_opensy --run_test=randomx_high_priority_tests || true

  tsan:
    name: ThreadSanitizer (TSan)
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build ccache \
            libboost-all-dev libevent-dev libsqlite3-dev \
            libssl-dev clang-17 llvm-17

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-tsan-${{ github.sha }}
          restore-keys: |
            ccache-tsan-

      - name: Configure with TSan
        run: |
          cmake -B build-tsan -G Ninja \
            -DCMAKE_C_COMPILER=clang-17 \
            -DCMAKE_CXX_COMPILER=clang++-17 \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_FLAGS="-fsanitize=thread -fno-omit-frame-pointer -g" \
            -DCMAKE_CXX_FLAGS="-fsanitize=thread -fno-omit-frame-pointer -g" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=thread" \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DBUILD_TESTS=ON

      - name: Build with TSan
        run: cmake --build build-tsan -j$(nproc)

      - name: Run context pool tests with TSan
        env:
          TSAN_OPTIONS: "second_deadlock_stack=1:history_size=7"
        run: |
          # Context pool has concurrent access patterns
          ./build-tsan/bin/test_opensy --run_test=randomx_pool_tests
          # Run parallel validation tests
          ./build-tsan/bin/test_opensy --run_test=randomx_parallel* || true

      - name: Run concurrent mining simulation
        env:
          TSAN_OPTIONS: "second_deadlock_stack=1"
        run: |
          # Run tests that simulate concurrent mining
          ./build-tsan/bin/test_opensy --run_test=randomx_stress* || true

  ubsan:
    name: UndefinedBehaviorSanitizer (UBSan)
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build ccache \
            libboost-all-dev libevent-dev libsqlite3-dev \
            libssl-dev clang-17 llvm-17

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-ubsan-${{ github.sha }}
          restore-keys: |
            ccache-ubsan-

      - name: Configure with UBSan
        run: |
          cmake -B build-ubsan -G Ninja \
            -DCMAKE_C_COMPILER=clang-17 \
            -DCMAKE_CXX_COMPILER=clang++-17 \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_FLAGS="-fsanitize=undefined -fno-omit-frame-pointer -g" \
            -DCMAKE_CXX_FLAGS="-fsanitize=undefined -fno-omit-frame-pointer -g" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=undefined" \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DBUILD_TESTS=ON

      - name: Build with UBSan
        run: cmake --build build-ubsan -j$(nproc)

      - name: Run all RandomX tests with UBSan
        env:
          UBSAN_OPTIONS: "print_stacktrace=1:halt_on_error=1"
        run: |
          ./build-ubsan/bin/test_opensy --run_test=randomx_tests
          ./build-ubsan/bin/test_opensy --run_test=randomx_pool_tests
          ./build-ubsan/bin/test_opensy --run_test=pow_tests

      - name: Run boundary condition tests
        env:
          UBSAN_OPTIONS: "print_stacktrace=1"
        run: |
          # Boundary tests are most likely to trigger UB
          ./build-ubsan/bin/test_opensy --run_test=*boundary* || true
          ./build-ubsan/bin/test_opensy --run_test=*edge* || true

  msan:
    name: MemorySanitizer (MSan)
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build ccache \
            clang-17 llvm-17 libc++-17-dev libc++abi-17-dev

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-msan-${{ github.sha }}
          restore-keys: |
            ccache-msan-

      - name: Build MSan-instrumented dependencies
        run: |
          # MSan requires all dependencies to be instrumented
          # This is a simplified version - full MSan requires more work
          echo "Note: Full MSan support requires instrumented libc++"

      - name: Configure with MSan
        run: |
          cmake -B build-msan -G Ninja \
            -DCMAKE_C_COMPILER=clang-17 \
            -DCMAKE_CXX_COMPILER=clang++-17 \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_FLAGS="-fsanitize=memory -fno-omit-frame-pointer -g -stdlib=libc++" \
            -DCMAKE_CXX_FLAGS="-fsanitize=memory -fno-omit-frame-pointer -g -stdlib=libc++" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=memory -stdlib=libc++ -lc++abi" \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DBUILD_TESTS=ON \
            -DUSE_SYSTEM_LIBS=OFF

      - name: Build with MSan
        run: cmake --build build-msan -j$(nproc) || echo "MSan build may fail due to uninstrumented deps"

      - name: Run tests with MSan (if build succeeded)
        env:
          MSAN_OPTIONS: "poison_in_dtor=1"
        run: |
          if [ -f ./build-msan/bin/test_opensy ]; then
            ./build-msan/bin/test_opensy --run_test=randomx_tests || echo "MSan test completed with issues"
          else
            echo "MSan build not available, skipping"
          fi

  summary:
    name: Sanitizer Summary
    needs: [asan, tsan, ubsan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## Sanitizer Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Sanitizer | Purpose | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ASan | Memory errors, leaks | ${{ needs.asan.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TSan | Data races, deadlocks | ${{ needs.tsan.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| UBSan | Undefined behavior | ${{ needs.ubsan.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "MSan is experimental and may not pass due to uninstrumented dependencies." >> $GITHUB_STEP_SUMMARY
