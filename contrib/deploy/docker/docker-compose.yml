# =============================================================================
# OpenSY Docker Compose
# =============================================================================
# Deploy a complete OpenSY node with optional services.
#
# Usage:
#   docker compose up -d              # Start all services
#   docker compose up -d opensyd   # Start only the node
#   docker compose logs -f            # View logs
#   docker compose down               # Stop all services
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # OpenSY Node
  # ---------------------------------------------------------------------------
  opensyd:
    build:
      context: ../../..
      dockerfile: contrib/deploy/docker/Dockerfile
    image: opensy/node:latest
    container_name: opensy-node
    restart: unless-stopped
    
    # Port mappings
    ports:
      - "9633:9633"      # P2P
      # - "9632:9632"    # RPC (uncomment if needed, be careful!)
    
    # Data persistence
    volumes:
      - opensy-data:/home/opensy/.opensy
      # Mount custom config (optional):
      # - ./opensy.conf:/home/opensy/.opensy/opensy.conf:ro
    
    # Environment variables
    environment:
      - OPENSY_DATA=/home/opensy/.opensy
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    
    # Healthcheck
    healthcheck:
      test: ["CMD", "opensy-cli", "-datadir=/home/opensy/.opensy", "getblockchaininfo"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    
    networks:
      - opensy-net

  # ---------------------------------------------------------------------------
  # Block Explorer (Optional)
  # ---------------------------------------------------------------------------
  explorer:
    image: btcpayserver/btc-rpc-explorer:latest
    container_name: opensy-explorer
    restart: unless-stopped
    depends_on:
      opensyd:
        condition: service_healthy
    
    ports:
      - "3002:3002"
    
    environment:
      BTCEXP_HOST: "0.0.0.0"
      BTCEXP_PORT: "3002"
      BTCEXP_BITCOIND_HOST: "opensyd"
      BTCEXP_BITCOIND_PORT: "9632"
      BTCEXP_BITCOIND_USER: "${RPC_USER:-opensyrpc}"
      BTCEXP_BITCOIND_PASS: "${RPC_PASS:-changeme}"
      BTCEXP_SITE_TITLE: "OpenSY Explorer"
      BTCEXP_SITE_DESC: "OpenSY Blockchain Explorer"
      BTCEXP_NO_RATES: "true"
      BTCEXP_PRIVACY_MODE: "false"
    
    networks:
      - opensy-net
    
    profiles:
      - explorer

  # ---------------------------------------------------------------------------
  # Prometheus Node Exporter (Optional - Monitoring)
  # ---------------------------------------------------------------------------
  node-exporter:
    image: prom/node-exporter:latest
    container_name: opensy-node-exporter
    restart: unless-stopped
    
    ports:
      - "9100:9100"
    
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    
    networks:
      - opensy-net
    
    profiles:
      - monitoring

# =============================================================================
# Volumes
# =============================================================================
volumes:
  opensy-data:
    name: opensy-blockchain-data
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  opensy-net:
    name: opensy-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
